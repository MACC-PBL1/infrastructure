---
# ============================================
# PARTE 1: Instalar dependencias del sistema
# ============================================
# Cowrie necesita Python, pip, y librer√≠as de desarrollo para compilar

- name: Actualizar cache de apt
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Instalar dependencias de cowrie
  apt:
    name:
      - python3-pip
      - python3-venv      # Para crear entorno virtual de Python
      - git               # Para clonar el repositorio
      - openssl
      - libssl-dev        # Librer√≠as para SSH
      - zlib1g-dev
      - authbind          # Permite a usuarios no-root usar puertos < 1024
      - libffi-dev
      - build-essential   # Compiladores necesarios
      - python3-dev
    state: present

# ============================================
# PARTE 2: Crear usuario cowrie
# ============================================
# Por seguridad, cowrie corre con su propio usuario, no como root

- name: Crear grupo cowrie
  group:
    name: "{{ cowrie_group }}"
    state: present

- name: Crear usuario cowrie
  user:
    name: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"
    home: "{{ cowrie_home }}"
    shell: /bin/bash
    create_home: yes
    state: present

# ============================================
# PARTE 3: Configurar authbind
# ============================================
# authbind permite que el usuario cowrie (no root) escuche en puerto 22

- name: Crear archivo authbind para puerto 22
  copy:
    content: ""
    dest: "/etc/authbind/byport/22" # Aseg√∫rate que {{ cowrie_honeypot_port }} es 22
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"
    mode: "0755"  # IMPORTANTE: authbind necesita ser ejecutable
    force: no

- name: Detener ssh.socket si existe
  systemd:
    name: ssh.socket
    state: stopped
  ignore_errors: yes

- name: Deshabilitar ssh.socket permanentemente
  systemd:
    name: ssh.socket
    enabled: no
    masked: yes
  ignore_errors: yes

# ============================================
# PARTE 4: Mover SSH real al puerto 2222
# ============================================
# As√≠ el honeypot puede usar el puerto 22 y t√∫ sigues pudiendo conectarte

- name: Cambiar puerto SSH a {{ cowrie_real_ssh_port }}
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port\s+'
    line: "Port {{ cowrie_real_ssh_port }}"
    backup: yes
  notify: Restart SSH

- name: Forzar reinicio de SSH inmediatamente
  meta: flush_handlers

- name: Esperar a que SSH est√© disponible en puerto {{ cowrie_real_ssh_port }}
  wait_for:
    port: "{{ cowrie_real_ssh_port }}"
    host: "{{ inventory_hostname }}"
    delay: 5
    timeout: 120
  delegate_to: localhost
  become : no

# ============================================
# PARTE 5: Clonar e instalar Cowrie
# ============================================

- name: Clonar repositorio cowrie
  shell: sudo -u {{ cowrie_user }} git clone {{ cowrie_repo }} {{ cowrie_install_dir }}
  args:
    creates: "{{ cowrie_install_dir }}/.git"

- name: Crear entorno virtual Python
  shell: sudo -u {{ cowrie_user }} python3 -m venv {{ cowrie_install_dir }}/cowrie-env
  args:
    creates: "{{ cowrie_install_dir }}/cowrie-env/bin/activate"

- name: Actualizar pip en el entorno virtual
  shell: |
    sudo -u {{ cowrie_user }} {{ cowrie_install_dir }}/cowrie-env/bin/pip install --upgrade pip setuptools wheel
  args:
    chdir: "{{ cowrie_install_dir }}"

- name: Instalar Cowrie en modo editable
  shell: |
    sudo -u {{ cowrie_user }} {{ cowrie_install_dir }}/cowrie-env/bin/pip install -e .
  args:
    chdir: "{{ cowrie_install_dir }}"

# ============================================
# PARTE 6: Configurar Cowrie
# ============================================

- name: Copiar configuraci√≥n de cowrie
  template:
    src: cowrie.cfg.j2
    dest: "{{ cowrie_install_dir }}/etc/cowrie.cfg"
    mode: "0644"

- name: Cambiar owner de configuraci√≥n a cowrie
  file:
    path: "{{ cowrie_install_dir }}/etc/cowrie.cfg"
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"

# ============================================
# PARTE 7: Crear servicio systemd
# ============================================
# Para que cowrie arranque autom√°ticamente al reiniciar la m√°quina

- name: Crear servicio systemd para cowrie
  template:
    src: cowrie.service.j2
    dest: /etc/systemd/system/cowrie.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart Cowrie

- name: Habilitar y arrancar cowrie
  systemd:
    name: cowrie
    enabled: yes
    state: started
    daemon_reload: yes

- name: Esperar a que Cowrie est√© escuchando en puerto {{ cowrie_honeypot_port }}
  wait_for:
    port: "{{ cowrie_honeypot_port }}"
    host: 127.0.0.1
    delay: 5
    timeout: 60
  become: no

- name: Verificar estado de Cowrie
  systemd:
    name: cowrie
    state: started
  register: cowrie_status

- name: Mostrar estado de Cowrie
  debug:
    msg: "Cowrie est√° {{ 'ACTIVO ‚úÖ' if cowrie_status.status.ActiveState == 'active' else 'INACTIVO ‚ùå' }}"

- name: Mostrar informaci√≥n importante
  debug:
    msg:
      - "üìÅ Logs de Cowrie: {{ cowrie_log_dir }}/cowrie.json"
      - "‚ö†Ô∏è  SSH real ahora est√° en puerto {{ cowrie_real_ssh_port }}"
      - "üéØ Honeypot escuchando en puerto {{ cowrie_honeypot_port }}"
---
- name: Actualizar cache de paquetes
  apt:
    update_cache: yes

- name: Actualizar sistema
  apt:
    upgrade: yes

- name: Instalar dependencias del sistema
  apt:
    name: "{{ cowrie_system_packages }}"
    state: present

- name: Crear usuario cowrie
  user:
    name: "{{ cowrie_user }}"
    shell: /bin/bash
    create_home: yes

- name: Configurar authbind
  file:
    path: /etc/authbind/byport
    state: directory
    mode: '0755'

- name: Configurar authbind para puerto 22
  file:
    path: "/etc/authbind/byport/{{ cowrie_listen_port }}"
    state: touch
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_user }}"
    mode: '0755'

- name: Copiar script de instalación
  copy:
    src: install_cowrie.sh
    dest: /tmp/install_cowrie.sh
    mode: '0755'

- name: Ejecutar instalación de Cowrie
  shell: /tmp/install_cowrie.sh
  args:
    creates: /home/cowrie/cowrie/cowrie-env

- name: Copiar archivos honeyfs de ejemplo
  shell: |
    if [ -d /home/cowrie/cowrie/honeyfs.example ] && [ ! -f /home/cowrie/cowrie/honeyfs/etc/passwd ]; then
      cp -r /home/cowrie/cowrie/honeyfs.example/* /home/cowrie/cowrie/honeyfs/ 2>/dev/null || true
      chown -R cowrie:cowrie /home/cowrie/cowrie/honeyfs
    fi

- name: Configurar Cowrie
  template:
    src: cowrie.cfg.j2
    dest: "{{ cowrie_home }}/cowrie/etc/cowrie.cfg"
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_user }}"
    mode: '0644'

- name: Cambiar puerto SSH real
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port\s+'
    line: "Port {{ ssh_real_port }}"

- name: Reiniciar SSH en segundo plano
  shell: "nohup bash -c 'sleep 2 && systemctl restart ssh' >/dev/null 2>&1 &"
  args:
    executable: /bin/bash

- name: Esperar a que SSH se reinicie
  pause:
    seconds: 10

- name: Crear servicio systemd para Cowrie
  template:
    src: cowrie.service.j2
    dest: /etc/systemd/system/cowrie.service
    owner: root
    group: root
    mode: '0644'

- name: Recargar systemd daemon
  systemd:
    daemon_reload: yes

- name: Detener cowrie si está corriendo manualmente
  shell: |
    su - cowrie -c "cd /home/cowrie/cowrie && cowrie-env/bin/cowrie stop 2>/dev/null" || true
  ignore_errors: yes

- name: Habilitar e iniciar servicio Cowrie
  systemd:
    name: cowrie
    enabled: yes
    state: started


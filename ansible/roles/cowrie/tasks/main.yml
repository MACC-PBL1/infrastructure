---
# ============================================
# PARTE 1: Instalar dependencias del sistema
# ============================================
# Cowrie necesita Python, pip, y librer√≠as de desarrollo para compilar

- name: Actualizar cache de apt
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Instalar dependencias de cowrie
  apt:
    name:
      - python3-pip
      - python3-venv      # Para crear entorno virtual de Python
      - git               # Para clonar el repositorio
      - openssl
      - libssl-dev        # Librer√≠as para SSH
      - zlib1g-dev
      - authbind          # Permite a usuarios no-root usar puertos < 1024
      - libffi-dev
      - build-essential   # Compiladores necesarios
      - python3-dev
    state: present

# ============================================
# PARTE 2: Crear usuario cowrie
# ============================================
# Por seguridad, cowrie corre con su propio usuario, no como root

- name: Crear grupo cowrie
  group:
    name: "{{ cowrie_group }}"
    state: present

- name: Crear usuario cowrie
  user:
    name: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"
    home: "{{ cowrie_home }}"
    shell: /bin/bash
    create_home: yes
    state: present

# ============================================
# PARTE 4: Mover SSH real al puerto 2222
# ============================================
# As√≠ el honeypot puede usar el puerto 22 y t√∫ sigues pudiendo conectarte

- name: Cambiar puerto SSH a {{ cowrie_real_ssh_port }}
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port\s+'
    line: "Port {{ cowrie_real_ssh_port }}"
    backup: yes
  notify: Restart SSH

- name: Forzar reinicio de SSH inmediatamente
  meta: flush_handlers

- name: Esperar a que SSH est√© disponible en puerto {{ cowrie_real_ssh_port }}
  wait_for:
    port: "{{ cowrie_real_ssh_port }}"
    host: "{{ inventory_hostname }}"
    delay: 5
    timeout: 120
  delegate_to: localhost
  become : no

# ============================================
# PARTE 5: Instalaci√≥n Limpia y Robusta
# ============================================

# 1. BORR√ìN Y CUENTA NUEVA.
# Eliminamos la carpeta existente para evitar conflictos de git, permisos o due√±os anteriores.
# Esto garantiza que la instalaci√≥n empieza desde cero y sin errores heredados.
- name: Eliminar instalaci√≥n previa corrupta o conflictiva
  file:
    path: "{{ cowrie_install_dir }}"
    state: absent
  become: yes

# 2. Clonamos como ROOT.
# Al haber borrado la carpeta, root la crear√° nueva y ser√° el due√±o leg√≠timo.
# Git ya no se quejar√° de "dubious ownership".
- name: Clonar repositorio cowrie (Clean Clone)
  git:
    repo: "{{ cowrie_repo }}"
    dest: "{{ cowrie_install_dir }}"
    version: main
    force: yes
  become: yes

# 3. Creamos el entorno virtual como ROOT
- name: Crear entorno virtual Python
  command: python3 -m venv {{ cowrie_install_dir }}/cowrie-env
  become: yes

# 4. Instalamos dependencias como ROOT
- name: Actualizar pip e instalar dependencias
  shell: |
    {{ cowrie_install_dir }}/cowrie-env/bin/pip install --upgrade pip setuptools wheel
    {{ cowrie_install_dir }}/cowrie-env/bin/pip install --upgrade -r {{ cowrie_install_dir }}/requirements.txt
    {{ cowrie_install_dir }}/cowrie-env/bin/pip install -e {{ cowrie_install_dir }}
  become: yes

# 5. PASO FINAL MAGICO: Entregamos las llaves a cowrie
# Una vez todo est√° instalado y compilado por root, le regalamos la carpeta al usuario cowrie.
- name: Asignar propiedad final a usuario cowrie
  file:
    path: "{{ cowrie_install_dir }}"
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"
    recurse: yes
    mode: "u=rwX,g=rX,o-rwx"
  become: yes

# ============================================
# PARTE 5.5: Crear estructura de directorios
# ============================================
# Git no clona carpetas vac√≠as, as√≠ que debemos crearlas
# para que Cowrie pueda escribir sus logs y guardar descargas.

- name: Crear directorios necesarios para Cowrie
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"
    mode: "0755"
  loop:
    - "{{ cowrie_install_dir }}/var/log/cowrie"
    - "{{ cowrie_install_dir }}/var/lib/cowrie/downloads"
    - "{{ cowrie_install_dir }}/var/lib/cowrie/tty"
    - "{{ cowrie_install_dir }}/var/run"
  become: yes

#- name: Dar permisos de ejecuci√≥n al script oficial de Cowrie
#  file:
#    path: "{{ cowrie_install_dir }}/bin/cowrie"
#    mode: "0755"
#    owner: "{{ cowrie_user }}"
#    group: "{{ cowrie_group }}"
#

# ============================================
# PARTE 6: Configurar Cowrie
# ============================================

- name: Copiar configuraci√≥n de cowrie
  template:
    src: cowrie.cfg.j2
    dest: "{{ cowrie_install_dir }}/etc/cowrie.cfg"
    mode: "0644"
    owner: "{{ cowrie_user }}"
    group: "{{ cowrie_group }}"

# ============================================
# PARTE 7: Configurar IPTables (Redirecci√≥n)
# ============================================
# Todo lo que llegue al puerto 22 se reenv√≠a al 2223

- name: Instalar iptables-persistent para guardar reglas
  apt:
    name: iptables-persistent
    state: present

- name: Redirigir puerto 22 al {{ cowrie_internal_port }} (NAT)
  iptables:
    table: nat
    chain: PREROUTING
    in_interface: eth0  # OJO: Verifica si tu interfaz es eth0 o ens5 con 'ip a'
    protocol: tcp
    match: tcp
    destination_port: 22
    jump: REDIRECT
    to_ports: "{{ cowrie_internal_port }}"
    comment: "Redirigir SSH trafico al Honeypot"
  become: yes

- name: Permitir tr√°fico en puerto {{ cowrie_internal_port }} (Input)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ cowrie_internal_port }}"
    jump: ACCEPT
  become: yes

- name: Guardar reglas de IPTables
  shell: netfilter-persistent save
  become: yes

# ============================================
# PARTE 8: Servicio Systemd
# ============================================

- name: Crear servicio systemd para cowrie
  template:
    src: cowrie.service.j2
    dest: /etc/systemd/system/cowrie.service
  notify: Restart Cowrie

- name: Forzar recarga de systemd
  systemd:
    daemon_reload: yes

- name: Asegurar que Cowrie est√° arrancado
  systemd:
    name: cowrie
    state: restarted # Forzamos reinicio para que pille el nuevo puerto
    enabled: yes

# Esperamos al puerto interno (2223) que es donde realmente corre el proceso
- name: Esperar a que Cowrie arranque en puerto {{ cowrie_internal_port }}
  wait_for:
    port: "{{ cowrie_internal_port }}"
    host: 127.0.0.1
    delay: 5
    timeout: 60

- name: Mostrar estado de Cowrie
  debug:
    msg: "Cowrie est√° {{ 'ACTIVO ‚úÖ' if cowrie_status.status.ActiveState == 'active' else 'INACTIVO ‚ùå' }}"

- name: Mostrar informaci√≥n importante
  debug:
    msg:
      - "üìÅ Logs de Cowrie: {{ cowrie_log_dir }}/cowrie.json"
      - "‚ö†Ô∏è  SSH real ahora est√° en puerto {{ cowrie_real_ssh_port }}"
      - "üéØ Honeypot escuchando en puerto {{ cowrie_honeypot_port }}"
